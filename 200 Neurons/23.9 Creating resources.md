---
note_type: note
tags:
  - programming
  - c#
  - web_development
  - .net_web_api
  -  efc
  - controllers
mn:
  - "[[12 Web Dev]]"
  - "[[13.7 C Sharp]]"
kt: theorical
checked:
---
[[13.9 ASP.NET Core Web API|ASP.NET Core Web API]]


This is the og code.
![[Pasted image 20250127084208.png]]

# Mapping the parameter to an entity
Creating a resource requires to map the creator parameter (a dto) to an entity, because the method will create a resource in one entity.

So, the poi for creation dto needs to be mapped to its entity.

![[Pasted image 20250127090805.png]]

This is a comparison between the entity and the dto. The entity has more properties, but that's no issue because the mapper will ignore those.

![[Pasted image 20250127090939.png]]

# Method implementation
## Check if a city exists
Call city exists, and add async, task and await.

![[Pasted image 20250127091026.png]]

## Get the last poi
The og method implement something to get an id, this can be removed because the PK id is autogenerated. So, to get to the final poi, map the incoming poi for creation dto to a poi entity. 

![[Pasted image 20250127091218.png]]

## Add the poi
Up to this point, there's no city entity in the implementation. Add one method to the repo interface (the last one).

Detail the method accept the poi entity 

![[Pasted image 20250127091351.png]]

This is the implementation inside of the repo. Detail there's no need for loading the poi, as I need to add new one, not to get one, that why includepoi is false. Then, if the city is not null, then add the poi to a collection of poi; this grants the FK is set to the correct PK. 

![[Pasted image 20250127091553.png]]

Now, this is not persistent yet because the add method adds it on the object context, is not int he db yet. That' why the `City.PointsofInterest.Add(pointOfInterest)` is not async, this is not an I/O operation, is not doing anything in the db.

### Adding the resource to the db
To persist something, called `saveChangesAsync` on the context. So create another method in the repo. This is a method of db context 

Here is the interface

![[Pasted image 20250127092016.png]]

![[Pasted image 20250127092113.png]]

This call will return the entities that have changed. This method is true when zero or more entities have successfully been saved. In other implementations is valid to return true when one or more items have successfully been changed. 

## In the controller
Call the two methods.

![[Pasted image 20250127092405.png]]

---

![[Pasted image 20250127093458.png]]

Detail that when executing a post method, before save changes, there's a poi entity that contains the description and name, values inputted in the dto, but the city, city id and id are default or null values, meaning their vales are not persisted yet in the db. 

![[Pasted image 20250127092955.png]]

After the save changes method, the final poi contains fk, pk, and it knows now the type of entity. 

![[Pasted image 20250127093300.png]]



---
If any of those two methods is wrong, something went wrong server side, meaning the return code will be 500. If the save went well the status will be 201. 

From the moment save changes has been called, the entity will have its id filled out, autogenerated at a db level. Finally map the entity back to dto and return it. 

![[Pasted image 20250127092619.png]]

## Response body
Detail the added poi, the one that contains the pk, id, and entity type, is mapped back to a dto and return. The image below is how the dto is mapped for creating a poi. 

![[Pasted image 20250127093343.png]]
